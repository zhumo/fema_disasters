<html>
<head>
  <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
  <script src="http://d3js.org/topojson.v1.min.js"></script>
  <style>
    .state {
      fill: white;
      stroke: black;
      fill-opacity: 0;
    }
    g:hover .state {
      stroke-width: 3px;
    }
  </style>
</head>
<body>
  <h1 style="text-align: center; display: none;">FEMA Disaster Declarations 1953 - Present</h1>
  <select id="incident_type_select" style="display: none; margin: auto;">
  </select>
  <svg id="map"></svg>
  <script>
    //Setup canvas
    var height = 700;
    var width = 1200;

    var map_canvas = d3.select("#map").attr({height: height, width: width}).style({display: "block", margin: "auto"});

    // Setup Data
    var projection = d3.geo.albersUsa().scale(1500).translate([width / 2, height / 2]);
    var path = d3.geo.path().projection(projection);
    d3.json("topo-usa.json", function(error, topo){
      var states_data = topojson.feature(topo, topo.objects.usa).features;
      var radiusScale = d3.scale.sqrt()
        .domain([
          d3.min(states_data,function(state_data){
            return state_data.properties.incidents_data["Total Incidents"];
          }), 
          d3.max(states_data,function(state_data){
            return state_data.properties.incidents_data["Total Incidents"];
          })
        ])
        .range([5,20]);

      

      //Group for each state
      map_canvas.selectAll("g")
        .data(states_data).enter()
          .append("g")
            .attr({
              id: function(d){
                return d["id"];
              }
            })

      //Draw each state
      map_canvas.selectAll("g")
        .append("path")
          .attr({
            d: path,
            id: function(d){
              return d["id"] + "_path";
            },
            class: "state"
          })

      //Draw the circles for each state. With Total Incidents as default.
      map_canvas.selectAll("g")
        .append("circle")
          .attr({
            transform: function(state_data){
              var position = path.centroid(state_data);
              var x = position[0];
              var y = position[1];
              switch(state_data.id){
                case "LA":
                  x = x - 10;
                  break;
                case "FL":
                  x = x + 20;
                  y = y + 10;
                  break;
                case "MA":
                  x = x - 10;
                  y = y - 1;
                  break;
                case "MI":
                  x = x + 15;
                  y = y + 25;
                  break;
                case "MD":
                  y = y - 8;
                  break;
                case "NJ":
                  x = x + 5;
                  break;
                case "AK":
                  y = y - 10;
                  break;
                case "HI":
                  x = x + 20;
                  y = y + 15;
                  break;
              }

              return "translate(" + x + "," + y + ")";
            },
            r: function(state_data){
              return radiusScale(state_data.properties.incidents_data["Total Incidents"]);
            },
            fill: "red",
            "z-index": 1,
            class: "circle",
            id: function(d){
              return d["id"] + "_circle";
            }
          });

      /*
      //Text for each circle
      map_canvas.selectAll("g")
        .append("text")
          .attr({
            transform: function(state_data){
              return "translate(" + path.centroid(state_data) + ")";
            },
            "text-anchor": "middle",
            "font-size": function(d){
              return 12;
            }
          }).text(function(d){
            return d.properties.incidents_data["Total Incidents"];
          });
          */

      var incident_types = [];
      d3.map(states_data, function(state_data){
        d3.map(Object.keys(state_data.properties.incidents_data),function(incident_type){
          if(incident_types.indexOf(incident_type) == -1){
            incident_types.push(incident_type);
          }
        });
      });

      incident_types.sort();

      d3.map(incident_types, function(type){
        d3.select("#incident_type_select")
          .append("option")
            .attr({
              value: type,
              selected: function(){
                if(type == "Total Incidents"){
                  return true
                }else{
                  return null;
                }
              }
            })
            .text(type);
      });

      d3.select("h1").style("display", "block");
      d3.select("#incident_type_select")
        .style({
          display: "block", 
          width: 200
        })
        .on("change", function(){
          var selected_incident_type = d3.select(this).node().value;
          radiusScale.domain([
            d3.min(states_data, function(state_data){
              return state_data.properties.incidents_data[selected_incident_type];
            }),
            d3.max(states_data, function(state_data){
              return state_data.properties.incidents_data[selected_incident_type];
            })
          ]);

          d3.selectAll("circle")
            .transition()
            .delay(500)
            .duration(1000)
            .ease("bounce")
            .attr("r", function(d){
              var incident_count = d.properties.incidents_data[selected_incident_type];
              if(typeof(incident_count) == "undefined"){
                return 0;
              }else{
                return radiusScale(incident_count);
              }
            });

          /*
          d3.selectAll("text")
            .transition()
            .delay(500)
            .duration(1000)
            .ease("linear")
            .text(function(d){
              var incident_count = d.properties.incidents_data[selected_incident_type];
              if(typeof(incident_count) == "undefined"){
                return null;
              }else{
                return incident_count;
              }
            });
            */
        });

    });
  </script>
</body>
</html>
